<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neural_Reader | MagazineHub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-teal: #62D2B3;
            --brand-deep: #12121A;
            --brand-lavender: #8B9BE1;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--brand-deep); 
            color: #F9EBE0;
            overflow: hidden; margin: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        #viewerContainer {
            height: 100vh;
            overflow-y: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-top: 80px;
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #12121a 100%);
        }

        /* Neural Placeholder */
        .page-slot {
            margin: 40px auto;
            background: rgba(255,255,255,0.01);
            border: 1px solid rgba(98, 210, 179, 0.05);
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
            max-width: 95%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .page-slot::before {
            content: "DATA_NODE_WAITING";
            font-family: 'JetBrains Mono';
            font-size: 10px;
            color: rgba(98, 210, 179, 0.2);
            letter-spacing: 4px;
        }

        canvas {
            display: block;
            max-width: 100% !important;
            height: auto !important;
            user-select: none;
        }

        /* Tactical HUD Header */
        #readerHeader { 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 100;
            border-bottom: 1px solid rgba(98, 210, 179, 0.1);
        }
        .header-hidden { transform: translateY(-100%); opacity: 0; }

        /* Progress Bar */
        #topProgress {
            position: absolute; bottom: 0; left: 0; height: 2px;
            background: var(--brand-teal); width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--brand-teal);
        }

        .loader-ring {
            border: 2px solid rgba(98, 210, 179, 0.1);
            border-top: 2px solid var(--brand-teal);
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body oncontextmenu="return false;">

    <nav id="readerHeader" class="fixed top-0 w-full h-16 bg-brand-deep/90 backdrop-blur-xl flex items-center justify-between px-6">
        <div id="topProgress"></div>
        <div class="flex items-center gap-6">
            <a href="index.html" class="group flex items-center gap-2 text-brand-lavender/60 hover:text-brand-teal transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                <span class="font-mono text-[10px] uppercase tracking-widest hidden md:block">Exit_Stream</span>
            </a>
            <div class="h-8 w-[1px] bg-white/5"></div>
            <div>
                <h1 id="readerTitle" class="text-white font-bold text-xs md:text-sm uppercase tracking-tighter truncate max-w-[150px] md:max-w-md">Initializing...</h1>
                <p id="pageCountDisplay" class="text-brand-teal font-mono text-[9px] uppercase tracking-[0.2em]">Syncing_Memory_Nodes</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <span id="readPercent" class="font-mono text-[10px] text-brand-teal/40 hidden sm:block">00%_READ</span>
            <button onclick="toggleFullScreen()" class="p-2 border border-white/5 hover:border-brand-teal/40 rounded transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-teal" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                </svg>
            </button>
        </div>
    </nav>

    <div id="loadingScreen" class="fixed inset-0 bg-brand-deep z-[200] flex flex-col items-center justify-center text-center px-6">
        <div class="loader-ring mb-8"></div>
        <div class="space-y-2">
            <h2 class="font-mono text-xs text-brand-teal uppercase tracking-[0.5em] animate-pulse">Initializing_Neural_Link</h2>
            <p id="loadStatus" class="text-white/20 text-[10px] font-mono uppercase tracking-widest">Awaiting Data Packets...</p>
        </div>
    </div>

    <main id="viewerContainer">
        <div id="canvasContainer" class="pb-32"></div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let lastScrollTop = 0;
        const container = document.getElementById('canvasContainer');
        const topBar = document.getElementById('topProgress');

        // IMPROVEMENT: Logic to find specific magazine faster
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (!id) { window.location.href = 'index.html'; return; }

            try {
                // In a production environment, you should use /api/magazines/${id} 
                // to avoid downloading the full list.
                const response = await fetch(`/api/magazines`);
                const mags = await response.json();
                const mag = mags.find(m => m.id == id);

                if (mag?.pdf_path) {
                    document.getElementById('readerTitle').innerText = mag.title.toUpperCase();
                    loadMagazine(mag.pdf_path);
                } else { throw new Error("File missing"); }
            } catch (err) {
                document.getElementById('loadStatus').innerText = "FATAL: CORE_DATA_MISSING";
            }
        }

        // IMPROVEMENT: Added visual progress tracking for the "Open" speed
        async function loadMagazine(path) {
            try {
                const loadingTask = pdfjsLib.getDocument({
                    url: path,
                    // Allows reading pages while still downloading
                    disableAutoFetch: false, 
                    disableStream: false 
                });

                loadingTask.onProgress = (p) => {
                    const percent = Math.round((p.loaded / (p.total || 1)) * 100);
                    topBar.style.width = `${percent}%`;
                    document.getElementById('loadStatus').innerText = `BUFFERING_DATA: ${percent}%`;
                };

                pdfDoc = await loadingTask.promise;
                document.getElementById('pageCountDisplay').innerText = `ARCHIVE: ${pdfDoc.numPages}_NODES`;

                const firstPage = await pdfDoc.getPage(1);
                const viewport = firstPage.getViewport({ scale: 1 });
                const aspectRatio = viewport.height / viewport.width;

                // Create Slots
                for (let n = 1; n <= pdfDoc.numPages; n++) {
                    const slot = document.createElement('div');
                    slot.className = 'page-slot';
                    slot.dataset.pagenum = n;
                    const slotWidth = Math.min(window.innerWidth * 0.95, 1000); 
                    slot.style.width = `${slotWidth}px`;
                    slot.style.height = `${slotWidth * aspectRatio}px`;
                    
                    container.appendChild(slot);
                    pageObserver.observe(slot);
                }

                revealUI();
            } catch (err) {
                console.error(err);
                document.getElementById('loadStatus').innerText = "DECRYPTION_FAILED";
            }
        }

        // Lazy Rendering Logic
        const pageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const pageNum = parseInt(entry.target.dataset.pagenum);
                    renderPage(pageNum, entry.target);
                    // UI Update: Progress percent
                    const total = pdfDoc.numPages;
                    const progress = Math.round((pageNum / total) * 100);
                    document.getElementById('readPercent').innerText = `${progress.toString().padStart(2, '0')}%_READ`;
                }
            });
        }, { rootMargin: '800px 0px', threshold: 0.01 });

        async function renderPage(num, targetElement) {
            if (targetElement.classList.contains('rendered')) return;
            targetElement.classList.add('rendered');

            const page = await pdfDoc.getPage(num);
            const clientWidth = window.innerWidth;
            const viewportDefault = page.getViewport({ scale: 1 });
            
            // Adjust scale based on device
            let scale = (clientWidth < 768) ? (clientWidth * 0.95) / viewportDefault.width : 1.5;
            const viewport = page.getViewport({ scale: scale });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d', { alpha: false }); // Performance boost
            const dpr = window.devicePixelRatio || 1;

            canvas.height = viewport.height * dpr;
            canvas.width = viewport.width * dpr;
            canvas.style.width = "100%";
            canvas.style.height = "100%";
            context.scale(dpr, dpr);

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            
            targetElement.innerHTML = '';
            canvas.className = 'opacity-0 transition-opacity duration-1000';
            targetElement.appendChild(canvas);
            
            requestAnimationFrame(() => canvas.classList.remove('opacity-0'));
            page.cleanup();
        }

        function revealUI() {
            anime({
                targets: '#loadingScreen',
                opacity: 0,
                duration: 1000,
                easing: 'easeOutExpo',
                complete: () => document.getElementById('loadingScreen').style.display = 'none'
            });
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        const viewer = document.getElementById('viewerContainer');
        viewer.addEventListener('scroll', () => {
            let st = viewer.scrollTop;
            if (st > lastScrollTop && st > 100) {
                document.getElementById('readerHeader').classList.add('header-hidden');
            } else {
                document.getElementById('readerHeader').classList.remove('header-hidden');
            }
            lastScrollTop = st;
        }, { passive: true });

        window.onload = init;
    </script>
</body>
</html>
